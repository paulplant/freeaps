var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(e/18,1):Math.round(e)}var i="",s="",l="",d="",u="",m="",c="",b="",g="",f="";function h(e,r){var a=[2,7,12,16,20,50,60,80,90,100,110,150,180,200],t=[0,0,.4,.7,.7,-.5,-.5,-.3,-.2,0,0,.5,.7,.7],o=a.length-1,n=a[0],i=t[0],s=a[o],l=t[o],d=1,u=1,m=1,c=n;if(n>e)d=(u=i)+((l=t[1])-u)/((s=a[1])-(m=n))*(e-m);else if(s<e)d=(u=i=t[o-1])+(l-u)/(s-(m=n=a[o-1]))*(e-m);else for(var b=0;b<=o;b++){if(i=t[b],(n=a[b])==e){d=i;break}if(n>e){d=u+(i-u)/(n-(m=c))*(e-m);break}u=i,c=n}return d*=e>100?r.higher_ISFrange_weight:e>40?r.lower_ISFrange_weight:r.delta_ISFrange_weight}function p(e,r,a){if(void 0===e.smb_delivery_ratio_bg_range||0===e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio set to fixed value "+e.smb_delivery_ratio),e.smb_delivery_ratio;var t=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r<=a)return console.error("SMB delivery ratio limited by minimum value "+t),t;var n=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r>=a+e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio limited by maximum value "+n),n;var i=t+(n-t)*(r-a)/e.smb_delivery_ratio_bg_range;return console.error("SMB delivery ratio set to interpolated value "+o(i,2)),i}e.exports=function(e,r,a,v,_,B,M,S,x,y){var C={},I=new Date;if(y&&(I=y),void 0===v||void 0===v.current_basal)return C.error="Error: could not get current basal rate",C;var F=t(v.current_basal,v),G=F,w=new Date;y&&(w=y);var O,T=new Date(e.date),A=o((w-T)/60/1e3,1),R=e.glucose,D=e.noise;O=e.delta>-.5?"+"+o(e.delta,0):o(e.delta,0);var U=Math.min(e.delta,e.short_avgdelta),j=Math.min(e.short_avgdelta,e.long_avgdelta),k=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(R<=10||38===R||D>=3)&&(C.reason="CGM is calibrating, in ??? state, or noise is high");if(R>60&&0==e.delta&&e.short_avgdelta>-1&&e.short_avgdelta<1&&e.long_avgdelta>-1&&e.long_avgdelta<1&&("fakecgm"==e.device?(console.error("CGM data is unchanged ("+n(R,v)+"+"+n(e.delta,v)+") for 5m w/ "+n(e.short_avgdelta,v)+" mg/dL ~15m change & "+n(e.long_avgdelta,2)+" mg/dL ~45m change"),console.error("Simulator mode detected ("+e.device+"): continuing anyway")):!0),A>12||A<-5?C.reason="If current system time "+w+" is correct, then BG data is too old. The last BG data was read "+A+"m ago at "+T:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?C.reason="CGM was just calibrated":C.reason="CGM data is unchanged ("+n(R,v)+"+"+n(e.delta,v)+") for 5m w/ "+n(e.short_avgdelta,v)+" mg/dL ~15m change & "+n(e.long_avgdelta,v)+" mg/dL ~45m change"),R<=10||38===R||D>=3||A>12||A<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>=G?(C.reason+=". Canceling high temp basal of "+r.rate,C.deliverAt=I,C.temp="absolute",C.duration=0,C.rate=0,C):0===r.rate&&r.duration>30?(C.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",C.deliverAt=I,C.temp="absolute",C.duration=30,C.rate=0,C):(C.reason+=". Temp "+r.rate+" <= current basal "+G+"U/hr; doing nothing. ",C);var P,W,q,E,z=v.max_iob;if(void 0!==v.min_bg&&(W=v.min_bg),void 0!==v.max_bg&&(q=v.max_bg),void 0!==v.enableSMB_high_bg_target&&(E=v.enableSMB_high_bg_target),void 0===v.min_bg||void 0===v.max_bg)return C.error="Error: could not determine target_bg. ",C;P=(v.min_bg+v.max_bg)/2;var L=v.exercise_mode||v.high_temptarget_raises_sensitivity,N=100,H=160;if(v.half_basal_exercise_target&&(H=v.half_basal_exercise_target),L&&v.temptargetSet&&P>N||v.low_temptarget_lowers_sensitivity&&v.temptargetSet&&P<N){var Z=H-N;sensitivityRatio=Z*(Z+P-N)<=0?v.autosens_max:Z/(Z+P-N),sensitivityRatio=Math.min(sensitivityRatio,v.autosens_max),sensitivityRatio=o(sensitivityRatio,2),process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+P+"; ")}else void 0!==_&&_&&(sensitivityRatio=_.ratio,process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(G=v.current_basal*sensitivityRatio,(G=t(G,v))!==F?process.stderr.write("Adjusting basal from "+F+" to "+G+"; "):process.stderr.write("Basal unchanged: "+G+"; ")),v.temptargetSet);else if(void 0!==_&&_&&(v.sensitivity_raises_target&&_.ratio<1||v.resistance_lowers_target&&_.ratio>1)){W=o((W-60)/_.ratio)+60,q=o((q-60)/_.ratio)+60;var $=o((P-60)/_.ratio)+60;P===($=Math.max(80,$))?process.stderr.write("target_bg unchanged: "+$+"; "):process.stderr.write("target_bg from "+P+" to "+$+"; "),P=$}var Q=200,J=200,K=200;if(e.noise>=2){var V=Math.max(1.1,v.noisyCGMTargetMultiplier);Math.min(250,v.maxRaw);Q=o(Math.min(200,W*V)),J=o(Math.min(200,P*V)),K=o(Math.min(200,q*V)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+P+" to "+J+"; "),W=Q,P=J,q=K}var X=W-.5*(W-40),Y=o(v.sens,1),ee=v.sens;void 0!==_&&_&&((ee=o(ee=v.sens/sensitivityRatio,1))!==Y?process.stderr.write("ISF from "+n(Y,v)+" to "+n(ee,v)):process.stderr.write("ISF unchanged: "+n(ee,v)),i+="Autosens, Ratio: "+sensitivityRatio+", ISF: "+n(Y,v)+"→"+n(ee,v)),console.error("CR:"+v.carb_ratio);var re=function(e,r){return console.error("Threshold: "+e.iob_threshold_percent+" IOB to maxIOB Quotient: "+o(r[0].iob/e.max_iob,4)),e.use_autoisf&&e.iob_threshold>0&&e.iob_threshold>r[0].iob?(s=", autoISF-SMB disabled:, IOB: "+o(r[0].iob,2)+", more than "+e.iob_threshold+", maxIOB: "+e.max_iob,console.error(s),"iobTH"):e.temptargetSet&&e.autoisf_temp_smb&&e.use_autoisf?e.min_bg%2==1?(s=", autoISF-SMB disabled:, odd TT",console.error(s),"blocked"):(s=", autoISF-SMB enforced:, even TT",console.error(s),"enforced"):"oref"}(v,a);if(ee=function(e,r,a,t,v,_,B,M){if(!a.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;var S=t.dura_p,x=t.delta_pl,y=t.delta_pn,C=t.r_squ,I=t.bg_acceleration,F=t.parabola_fit_a0,G=t.parabola_fit_a1,w=t.parabola_fit_a2,O=t.autoISF_duration,T=t.autoISF_average,A=a.autoisf_max,R=!1,D=1,U=1,j=1,k=r+10-T;if(!(v.mealCOB>0)||a.enableautoisf_with_COB){var P=t.pp_debug;if(c+="BG-accel: "+o(I,3)+", PF-minutes: "+S+", PF-corr: "+o(C,4)+", PF-nextDelta: "+n(y,a)+", PF-lastDelta: "+n(x,a)+", regular Delta: "+n(t.delta,a),console.error(P+c+" , Weights Accel/Brake: "+a.bgAccel_ISF_weight+" / "+a.bgBrake_ISF_weight),a.enable_BG_acceleration){var W=I;if(0!=t.parabola_fit_a2){var q=-G/2/w*5,E=o(F-q*q/25*w,1);(q=o(q,1))<0&&W<0?(f="saw max of "+n(E,a)+", about "+-q+" min ago",console.error("Parabolic fit "+f)):q<0&&W>0?(f="saw min of "+n(E,a)+", about "+-q+" min ago",console.error("Parabolic fit "+f)):q>0&&W<0?(f="predicts max of "+n(E,a)+", in about "+q+"min",console.error("Parabolic fit "+f)):q>0&&W>0&&(f="predicts min of "+n(E,a)+", in about "+q+" min",console.error("Parabolic fit "+f))}var z=C;if(z<=.9)f="acce_ISF by-passed, as correlation, "+o(z,3)+", is too low",console.error("Parabolic fit "+f),b+=", Parabolic Fit, "+f;else{b+=", Parabolic Fit, "+f+", lastΔ: "+n(x,a)+", nextΔ: "+n(y,a)+", Corr "+o(C,3)+", BG-Accel: "+o(W,2);var L=10*(z-.9),N=1,H=1;t.glucose<a.target_bg?W>0?(W>1&&(N=.5),H=a.bgBrake_ISF_weight):W<0&&(H=a.bgAccel_ISF_weight):W<0?H=a.bgBrake_ISF_weight:W>0&&(H=a.bgAccel_ISF_weight),j=1+W*N*H*L,console.error("Original result for acce_ISF: "+o(j,2)),1!=j&&(R=!0,b+=", acce-ISF Ratio: "+o(j,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");var Z=p(a,t.glucose,r);i+=s+", SMB Delivery Ratio:, "+o(Z,2)+b+", autoISF";var $=1+h(100-k,a);console.error("bg_ISF adaptation is "+o($,2)),$<1&&j>1&&(g="bg-ISF adaptation lifted to "+o($*=j,2)+", as BG accelerates already",l="(lifted by "+o(j,2)+")",console.error(g));var Q=1;if($<1)return(Q=Math.min($,j))<a.autoisf_min&&(g="final ISF factor "+o(Q,2)+" limited by autoisf_min "+a.autoisf_min,console.error(g),Q=a.autoisf_min),l=" (lmtd.)",earlysens=Math.min(720,o(a.sens/Math.min(M,Q),1)),console.error("early Return autoISF:  "+n(earlysens,a)),i+=", bg-ISF Ratio: "+o($,2)+l+", ISF: "+n(earlysens,a),earlysens;$>1&&(R=!0,i+=", bg-ISF Ratio: "+o($,2));var J=t.delta;k>0?console.error("delta_ISF adaptation by-passed as average glucose < "+n(r+10,a)):t.short_avgdelta<0?console.error("delta_ISF adaptation by-passed as no rise or too short lived"):a.enableppisf_always||a.postmeal_ISF_duration>=(_-v.lastCarbTime)/1e3/3600?(D=1+Math.max(0,J*a.postmeal_ISF_weight),console.error("pp_ISF adaptation is "+o(D,2)),u=", pp-ISF Ratio: "+o(D,2),1!=D&&(R=!0)):(U=h(J,a),k>-20&&(U*=.5),U=1+U,console.error("delta_ISF adaptation is "+o(U,2)),m=", Δ-ISF Ratio: "+o(U,2),1!=U&&(R=!0));var K=1,V=a.autoisf_hourlychange;return v.mealCOB>0&&!a.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1)):O<10?console.error("dura_ISF by-passed; BG is only "+O+"m at level "+T):T<=r?console.error("dura_ISF by-passed; avg. glucose "+T+" below target "+n(r,a)):(K+=O/60*(V/r)*(T-r),R=!0,d=", Duration: "+O+", Avg: "+n(T,a)+", dura-ISF Ratio: "+o(K,2),console.error("dura_ISF  adaptation is "+o(K,2)+" because ISF "+e+" did not do it for "+o(O,1)+"m")),Q=1,R?(Q=Math.max(K,$,U,j,D),console.error("autoISF adaption ratios:"),console.error("  dura "+o(K,2)),console.error("  bg "+o($,2)),console.error("  delta "+o(U,2)),console.error("  pp "+o(D,2)),console.error("  accel "+o(j,2)),j<1&&(console.error("strongest ISF factor "+o(Q,2)+" weakened to "+o(Q*j,2)+" as bg decelerates already"),Q*=j),Q<a.autoisf_min?(console.error("final ISF factor "+o(Q,2)+" limited by autoisf_min "+a.autoisf_min),Q=a.autoisf_min):Q>A&&(console.error("final ISF factor "+o(Q,2)+" limited by autoisf_max "+A),Q=A),Q>=1&&(e=o(a.sens/Math.max(Q,M),1)),Q<1&&(e=o(a.sens/Math.min(Q,M),1))):Q=M,i+=u+m+d+", final Ratio: "+o(Q,2)+", final ISF: "+n(e,a),console.error("Inside autoISF: Ratio "+o(Q,2)+" resulting in "+n(e,a)),e}return console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1)),i+=", autoISF, disabled with COB",e}(ee,P,v,e,B,y,0,sensitivityRatio),void 0===a)return C.error="Error: iob_data undefined. ",C;var ae,te=a;if(a.length,a.length>1&&(a=te[0]),void 0===a.activity||void 0===a.iob)return C.error="Error: iob_data missing some property. ",C;var oe=((ae=void 0!==a.lastTemp?o((new Date(w).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+ae+"m, tempModulus:"+oe+"m"),C.temp="absolute",C.deliverAt=I,S&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&ae>10&&r.duration)return C.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",M.setTempBasal(0,0,v,C,r);if(r&&a.lastTemp&&r.duration>0){var ne=ae-a.lastTemp.duration;if(ne>5&&ae>10)return C.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+ne+"m ago; canceling temp",M.setTempBasal(0,0,v,C,r)}var ie=o(-a.activity*ee*5,2),se=o(6*(U-ie));se<0&&(se=o(6*(j-ie)))<0&&(se=o(6*(e.long_avgdelta-ie)));var le=R,de=(le=a.iob>0?o(R-a.iob*ee):o(R-a.iob*Math.min(ee,v.sens)))+se;if(void 0===de||isNaN(de))return C.error="Error: could not calculate eventualBG. Sensitivity: "+ee+" Deviation: "+se,C;var ue=function(e,r,a){return o(a+(e-r)/24,1)}(P,de,ie);C={temp:"absolute",bg:R,tick:O,eventualBG:de,insulinReq:0,reservoir:x,deliverAt:I,sensitivityRatio};var me=[],ce=[],be=[],ge=[];me.push(R),ce.push(R),ge.push(R),be.push(R);var fe=!1;S&&"oref"!=re?"enforced"==re&&(fe=!0):fe=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of",o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(v,S,B,R,P,E);var he=v.enableUAM,pe=0,ve=0;pe=o(U-ie,1);var _e=o(U-ie,1);csf=ee/v.carb_ratio,console.error("profile.sens:"+n(v.sens,v)+", sens:"+n(ee,v)+", CSF:"+o(csf,1));var Be=o(30*csf*5/60,1);pe>Be&&(console.error("Limiting carb impact from "+pe+" to "+Be+"mg/dL/5m (30g/h)"),pe=Be);var Me=3;sensitivityRatio&&(Me/=sensitivityRatio);var Se=Me;if(B.carbs){Me=Math.max(Me,B.mealCOB/20);var xe=o((new Date(w).getTime()-B.lastCarbTime)/6e4),ye=(B.carbs-B.mealCOB)/B.carbs;Se=o(Se=Me+1.5*xe/60,1),console.error("Last carbs "+xe+" minutes ago; remainingCATime:"+Se+"hours; "+o(100*ye)+"% carbs absorbed")}var Ce=Math.max(0,pe/5*60*Se/2)/csf,Ie=90,Fe=1;v.remainingCarbsCap&&(Ie=Math.min(90,v.remainingCarbsCap)),v.remainingCarbsFraction&&(Fe=Math.min(1,v.remainingCarbsFraction));var Ge=1-Fe,we=Math.max(0,B.mealCOB-Ce-B.carbs*Ge),Oe=(we=Math.min(Ie,we))*csf*5/60/(Se/2),Te=o(B.slopeFromMaxDeviation,2),Ae=o(B.slopeFromMinDeviation,2),Re=Math.min(Te,-Ae/3),De=0;0===pe?ve=0:!0===v.floating_carbs?(ve=Math.min(60*Se/5/2,Math.max(0,B.carbs*csf/pe)),De=Math.min(60*Se/5/2,Math.max(0,B.mealCOB*csf/pe)),B.carbs>0&&(i+=", Floating Carbs:, CID: "+o(ve,1)+", MealCarbs: "+o(B.carbs,1)+", Not Floating:, CID: "+o(De,1)+", MealCOB: "+o(B.mealCOB,1),console.error("Floating Carbs CID: "+o(ve,1)+" / MealCarbs: "+o(B.carbs,1)+" vs. Not Floating:"+o(De,1)+" / MealCOB:"+o(B.mealCOB,1)))):ve=Math.min(60*Se/5/2,Math.max(0,B.mealCOB*csf/pe)),console.error("Carb Impact:"+pe+"mg/dL per 5m; CI Duration:"+o(5*ve/60*2,1)+"hours; remaining CI ("+Se/2+"h peak):",o(Oe,1)+"mg/dL per 5m");var Ue,je,ke,Pe,We,qe=999,Ee=999,ze=999,Le=R,Ne=999,He=999,Ze=999,$e=999,Qe=de,Je=R,Ke=R,Ve=0,Xe=[],Ye=[];try{te.forEach((function(e){var r=o(-e.activity*ee*5,2),a=o(-e.iobWithZeroTemp.activity*ee*5,2),t=pe*(1-Math.min(1,ce.length/12));Qe=ce[ce.length-1]+r+t;var n=ge[ge.length-1]+a,i=Math.max(0,Math.max(0,pe)*(1-me.length/Math.max(2*ve,1))),s=Math.min(me.length,12*Se-me.length),l=Math.max(0,s/(Se/2*12)*Oe);i+l,Xe.push(o(l,0)),Ye.push(o(i,0)),COBpredBG=me[me.length-1]+r+Math.min(0,t)+i+l;var d=Math.max(0,_e+be.length*Re),u=Math.max(0,_e*(1-be.length/Math.max(36,1))),m=Math.min(d,u);m>0&&(Ve=o(5*(be.length+1)/60,1)),UAMpredBG=be[be.length-1]+r+Math.min(0,t)+m,ce.length<48&&ce.push(Qe),me.length<48&&me.push(COBpredBG),be.length<48&&be.push(UAMpredBG),ge.length<48&&ge.push(n),COBpredBG<Ne&&(Ne=o(COBpredBG)),UAMpredBG<He&&(He=o(UAMpredBG)),Qe<Ze&&(Ze=o(Qe)),n<$e&&($e=o(n));ce.length>18&&Qe<qe&&(qe=o(Qe)),Qe>Je&&(Je=Qe),(ve||Oe>0)&&me.length>18&&COBpredBG<Ee&&(Ee=o(COBpredBG)),(ve||Oe>0)&&COBpredBG>Je&&(Ke=COBpredBG),he&&be.length>12&&UAMpredBG<ze&&(ze=o(UAMpredBG)),he&&UAMpredBG>Je&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}B.mealCOB&&(console.error("predCIs (mg/dL/5m):"+Ye.join(" ")),console.error("remainingCIs:      "+Xe.join(" "))),C.predBGs={},ce.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var er=ce.length-1;er>12&&ce[er-1]===ce[er];er--)ce.pop();for(C.predBGs.IOB=ce,ke=o(ce[ce.length-1]),ge.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),er=ge.length-1;er>6&&!(ge[er-1]>=ge[er]||ge[er]<=P);er--)ge.pop();if(C.predBGs.ZT=ge,o(ge[ge.length-1]),B.mealCOB>0&&(pe>0||Oe>0)){for(me.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),er=me.length-1;er>12&&me[er-1]===me[er];er--)me.pop();C.predBGs.COB=me,Pe=o(me[me.length-1]),de=Math.max(de,o(me[me.length-1]))}if(pe>0||Oe>0){if(he){for(be.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),er=be.length-1;er>12&&be[er-1]===be[er];er--)be.pop();C.predBGs.UAM=be,We=o(be[be.length-1]),be[be.length-1]&&(de=Math.max(de,o(be[be.length-1])))}C.eventualBG=de}console.error("UAM Impact:"+_e+"mg/dL per 5m; UAM Duration:"+Ve+"hours"),qe=Math.max(39,qe),Ee=Math.max(39,Ee),ze=Math.max(39,ze),Ue=o(qe);var rr=B.mealCOB/B.carbs;je=o(ze<999&&Ee<999?(1-rr)*UAMpredBG+rr*COBpredBG:Ee<999?(Qe+COBpredBG)/2:ze<999?(Qe+UAMpredBG)/2:Qe),$e>je&&(je=$e),Le=o(Le=ve||Oe>0?he?rr*Ne+(1-rr)*He:Ne:he?He:Ze);var ar=ze;if($e<X)ar=(ze+$e)/2;else if($e<P){var tr=($e-X)/(P-X);ar=(ze+(ze*tr+$e*(1-tr)))/2}else $e>ze&&(ar=(ze+$e)/2);if(ar=o(ar),B.carbs)if(!he&&Ee<999)Ue=o(Math.max(qe,Ee));else if(Ee<999){var or=rr*Ee+(1-rr)*ar;Ue=o(Math.max(qe,Ee,or))}else Ue=he?ar:Le;else he&&(Ue=o(Math.max(qe,ar)));Ue=Math.min(Ue,je),process.stderr.write("minPredBG: "+Ue+" minIOBPredBG: "+qe+" minZTGuardBG: "+$e),Ee<999&&process.stderr.write(" minCOBPredBG: "+Ee),ze<999&&process.stderr.write(" minUAMPredBG: "+ze),console.error(" avgPredBG:"+je+" COB/Carbs:"+B.mealCOB+"/"+B.carbs),Ke>R&&(Ue=Math.min(Ue,Ke)),C.COB=B.mealCOB,C.IOB=a.iob,C.BGI=n(ie,v),C.deviation=n(se,v),C.ISF=n(ee,v),C.CR=o(v.carb_ratio,2),C.target_bg=n(P,v),C.reason=i+", Standard, COB: "+C.COB+", Dev: "+C.deviation+", BGI: "+C.BGI+", ISF: "+C.ISF+", CR: "+C.CR+", minPredBG "+n(Ue,v)+", minGuardBG "+n(Le,v)+", IOBpredBG "+n(ke,v),Pe>0&&(C.reason+=", COBpredBG "+n(Pe,v)),We>0&&(C.reason+=", UAMpredBG "+n(We,v)),C.reason+="; ";var nr=le;nr<40&&(nr=Math.min(Le,nr));var ir,sr=X-nr,lr=240,dr=240;if(B.mealCOB>0&&(pe>0||Oe>0)){for(er=0;er<me.length;er++)if(me[er]<W){lr=5*er;break}for(er=0;er<me.length;er++)if(me[er]<X){dr=5*er;break}}else{for(er=0;er<ce.length;er++)if(ce[er]<W){lr=5*er;break}for(er=0;er<ce.length;er++)if(ce[er]<X){dr=5*er;break}}fe&&Le<X&&(console.error("minGuardBG "+n(Le,v)+" projected below "+n(X,v)+" - disabling SMB"),fe=!1),void 0===v.maxDelta_bg_threshold&&(ir=.2),void 0!==v.maxDelta_bg_threshold&&(ir=Math.min(v.maxDelta_bg_threshold,.4)),k>ir*R&&(console.error("maxDelta "+n(k,v)+" > "+100*ir+"% of BG "+n(R,v)+" - disabling SMB"),C.reason+="maxDelta "+n(k,v)+" > "+100*ir+"% of BG "+n(R,v)+" - SMB disabled!, ",fe=!1),console.error("BG projected to remain above "+n(W,v)+" for "+lr+"minutes"),(dr<240||lr<60)&&console.error("BG projected to remain above "+n(X,v)+" for "+dr+"minutes");var ur=dr,mr=v.current_basal*ee*ur/60,cr=Math.max(0,B.mealCOB-.25*B.carbs),br=(sr-mr)/csf-cr;mr=o(mr),br=o(br),console.error("naive_eventualBG:",le,"bgUndershoot:",sr,"zeroTempDuration:",ur,"zeroTempEffect:",mr,"carbsReq:",br),"Could not parse clock data"==B.reason?console.error("carbsReq unknown: Could not parse clock data"):br>=v.carbsReqThreshold&&dr<=45&&(C.carbsReq=br,C.reason+=br+" add'l carbs req w/in "+dr+"m; ");var gr=0;if(R<X&&a.iob<20*-v.current_basal/60&&U>0&&U>ue)C.reason+="IOB "+a.iob+" < "+o(20*-v.current_basal/60,2),C.reason+=" and minDelta "+n(U,v)+" > expectedDelta "+n(ue,v)+"; ";else if(R<X||Le<X)return C.reason+="minGuardBG "+n(Le,v)+"<"+n(X,v),gr=o(60*((sr=P-Le)/ee)/v.current_basal),gr=30*o(gr/30),gr=Math.min(120,Math.max(30,gr)),M.setTempBasal(0,gr,v,C,r);if(v.skip_neutral_temps&&C.deliverAt.getMinutes()>=55)return C.reason+="; Canceling temp at "+C.deliverAt.getMinutes()+"m past the hour. ",M.setTempBasal(0,0,v,C,r);var fr=0,hr=G;if(de<W){if(C.reason+="Eventual BG "+n(de,v)+" < "+n(W,v),U>ue&&U>0&&!br)return le<40?(C.reason+=", naive_eventualBG < 40. ",M.setTempBasal(0,30,v,C,r)):(e.delta>U?C.reason+=", but Delta "+n(O,v)+" > expectedDelta "+n(ue,v):C.reason+=", but Min. Delta "+U.toFixed(2)+" > Exp. Delta "+n(ue,v),r.duration>15&&t(G,v)===t(r.rate,v)?(C.reason+=", temp "+r.rate+" ~ req "+G+"U/hr. ",C):(C.reason+="; setting current basal of "+G+" as temp. ",M.setTempBasal(G,30,v,C,r)));fr=o(fr=2*Math.min(0,(de-P)/ee),2);var pr=Math.min(0,(le-P)/ee);if(pr=o(pr,2),U<0&&U>ue)fr=o(fr*(U/ue),2);if(hr=t(hr=G+2*fr,v),r.duration*(r.rate-G)/60<Math.min(fr,pr)-.3*G)return C.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",M.setTempBasal(hr,30,v,C,r);if(void 0!==r.rate&&r.duration>5&&hr>=.8*r.rate)return C.reason+=", temp "+r.rate+" ~< req "+hr+"U/hr. ",C;if(hr<=0){if((gr=o(60*((sr=P-le)/ee)/v.current_basal))<0?gr=0:(gr=30*o(gr/30),gr=Math.min(120,Math.max(0,gr))),gr>0)return C.reason+=", setting "+gr+"m zero temp. ",M.setTempBasal(hr,gr,v,C,r)}else C.reason+=", setting "+hr+"U/hr. ";return M.setTempBasal(hr,30,v,C,r)}if(U<ue&&(!S||!fe))return e.delta<U?C.reason+="Eventual BG "+n(de,v)+" > "+n(W,v)+" but Delta "+n(O,v)+" < Exp. Delta "+n(ue,v):C.reason+="Eventual BG "+n(de,v)+" > "+n(W,v)+" but Min. Delta "+U.toFixed(2)+" < Exp. Delta "+n(ue,v),r.duration>15&&t(G,v)===t(r.rate,v)?(C.reason+=", temp "+r.rate+" ~ req "+G+"U/hr. ",C):(C.reason+="; setting current basal of "+G+" as temp. ",M.setTempBasal(G,30,v,C,r));if(Math.min(de,Ue)<q&&(!S||!fe))return C.reason+=n(de,v)+"-"+n(Ue,v)+" in range: no temp required",r.duration>15&&t(G,v)===t(r.rate,v)?(C.reason+=", temp "+r.rate+" ~ req "+G+"U/hr. ",C):(C.reason+="; setting current basal of "+G+" as temp. ",M.setTempBasal(G,30,v,C,r));if(de>=q&&(C.reason+="Eventual BG "+n(de,v)+" >= "+n(q,v)+", "),a.iob>z)return C.reason+="IOB "+o(a.iob,2)+" > max_iob "+z,r.duration>15&&t(G,v)===t(r.rate,v)?(C.reason+=", temp "+r.rate+" ~ req "+G+"U/hr. ",C):(C.reason+="; setting current basal of "+G+" as temp. ",M.setTempBasal(G,30,v,C,r));(fr=o((Math.min(Ue,de)-P)/ee,2))>z-a.iob&&(C.reason+="max_iob "+z+", ",fr=z-a.iob),hr=t(hr=G+2*fr,v),fr=o(fr,3),C.insulinReq=fr;var vr=o((new Date(w).getTime()-a.lastBolusTime)/6e4,1);if(S&&fe&&R>X){var _r=o(B.mealCOB/v.carb_ratio,3);if(v.use_autoisf)Br=v.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var Br=1}Br>1&&console.error("SMB max range extended from default by factor "+Br);var Mr=0;void 0===v.maxSMBBasalMinutes?(Mr=o(Br*v.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>_r&&a.iob>0?(console.error("IOB",a.iob,"> COB",B.mealCOB+"; mealInsulinReq =",_r),v.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",v.maxUAMSMBBasalMinutes,"profile.current_basal:",v.current_basal),Mr=o(Br*v.current_basal*v.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),Mr=o(30*v.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",v.maxSMBBasalMinutes,"profile.current_basal:",v.current_basal),Mr=o(Br*v.current_basal*v.maxSMBBasalMinutes/60,1));var Sr=v.bolus_increment,xr=1/Sr;if(v.use_autoisf)var yr=p(v,R,P);else console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),yr=.5;yr>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(yr,2));var Cr=Math.min(fr*yr,Mr);Cr=Math.floor(Cr*xr)/xr,gr=o(60*((P-(le+qe)/2)/ee)/v.current_basal),fr>0&&Cr<Sr&&(gr=0);var Ir=0;gr<=0?gr=0:gr>=30?(gr=30*o(gr/30),gr=Math.min(60,Math.max(0,gr))):(Ir=o(G*gr/30,2),gr=30),C.reason+=" insulinReq "+fr,Cr>=Mr&&(C.reason+="; maxBolus "+Mr),gr>0&&(C.reason+="; setting "+gr+"m low temp of "+Ir+"U/h"),C.reason+=". ";var Fr=3;v.SMBInterval&&(Fr=Math.min(10,Math.max(1,v.SMBInterval)));var Gr=o(Fr-vr,0),wr=o(60*(Fr-vr),0)%60;if(console.error("naive_eventualBG",le+",",gr+"m "+Ir+"U/h temp needed; last bolus",vr+"m ago; maxBolus: "+Mr),vr>Fr?Cr>0&&(C.units=Cr,C.reason+="Microbolusing "+Cr+"U. "):C.reason+="Waiting "+Gr+"m "+wr+"s to microbolus again. ",gr>0)return C.rate=Ir,C.duration=gr,C}var Or=M.getMaxSafeBasal(v);return hr>Or&&(C.reason+="adj. req. rate: "+hr+" to maxSafeBasal: "+Or+", ",hr=t(Or,v)),r.duration*(r.rate-G)/60>=2*fr?(C.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+hr+"U/hr. ",M.setTempBasal(hr,30,v,C,r)):void 0===r.duration||0===r.duration?(C.reason+="no temp, setting "+hr+"U/hr. ",M.setTempBasal(hr,30,v,C,r)):r.duration>5&&t(hr,v)<=t(r.rate,v)?(C.reason+="temp "+r.rate+" >~ req "+hr+"U/hr. ",C):(C.reason+="temp "+r.rate+"<"+hr+"U/hr. ",M.setTempBasal(hr,30,v,C,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,d=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?d(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();